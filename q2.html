<!doctype html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>P2 — Movimiento</title>
<link rel="stylesheet" href="style.css">
<script defer src="state.js"></script>
</head><body>
<main class="wrap">
  <div class="card">
    <h1>2) ¿qué movimiento ves?</h1>
  

    <div class="grid2">
      <div>
        <video id="cam" playsinline autoplay muted style="width:100%;border-radius:12px;background:#000"></video>
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="rec">● Grabar</button>
          <button class="btn" id="stop" disabled>■ Detener</button>
        </div>
      </div>

      <div>
        <label>Previsualización</label>
        <div class="preview" id="prev">Aún sin vídeo</div>
      </div>
    </div>

    <div class="actions">
      <a class="btn" href="q1.html">← Volver</a>
      <button class="btn primary" id="next" disabled>Siguiente →</button>
    </div>
    <p class="hint">El vídeo se guarda solo en tu navegador (prototipo local). Luego lo conectaremos a Supabase para archivo compartido.</p>
  </div>
</main>

<script>
const video = document.getElementById('cam');
const btnRec = document.getElementById('rec');
const btnStop = document.getElementById('stop');
const prev = document.getElementById('prev');
const btnNext = document.getElementById('next');

let recorder, stream, chunks=[], videoDataUrl=null;

// iniciar cámara
async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    video.srcObject = stream;
  }catch(e){
    alert('No se pudo acceder a la cámara. Revisa permisos o usa otro navegador.');
  }
}
startCamera();

// grabar
btnRec.addEventListener('click', ()=>{
  if(!stream){ alert('Cámara no disponible'); return; }
  chunks = [];
  recorder = new MediaRecorder(stream, { mimeType:'video/webm' });
  recorder.ondataavailable = e=> chunks.push(e.data);
  recorder.onstop = async ()=>{
    const blob = new Blob(chunks, { type:'video/webm' });
    videoDataUrl = await blobToDataURL(blob);
    const v = document.createElement('video');
    v.controls=true; v.src=videoDataUrl; v.style.width='100%'; v.style.borderRadius='12px';
    prev.innerHTML=''; prev.appendChild(v);
    btnNext.disabled=false;
  };
  recorder.start();
  btnRec.disabled=true; btnStop.disabled=false;
  setTimeout(()=>{ if(recorder.state==='recording'){ recorder.stop(); } }, 5000); // auto stop a los 5s
});

btnStop.addEventListener('click', ()=>{
  if(recorder && recorder.state==='recording'){ recorder.stop(); }
  btnRec.disabled=false; btnStop.disabled=true;
});

// pasar a siguiente
btnNext.addEventListener('click', ()=>{
  writeTmp({ videoClip: videoDataUrl || null });
  // detener cámara
  if(stream){ stream.getTracks().forEach(t=>t.stop()); }
  location.href='q3.html';
});

// detener cámara al salir
window.addEventListener('pagehide', ()=>{
  if(stream){ stream.getTracks().forEach(t=>t.stop()); }
});
</script>
</body></html>
