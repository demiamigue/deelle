<!doctype html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>P1 â€” Objeto en la cabeza</title>
<link rel="stylesheet" href="style.css">
<script defer src="state.js"></script>
<style>#cam.mirror{transform:scaleX(-1);}</style>
</head><body>
<main class="wrap">
  <div class="card">
    <h1>1) Â¿QuÃ© objeto llevas en la cabeza hoy?</h1>

    <div class="grid2">
      <div>
        <label for="headText"> el que?</label>
        <input id="headText" maxlength="40" placeholder="...">
        <label style="margin-top:10px">CÃ¡mara en vivo</label>
        <div class="preview" style="padding:0">
          <video id="cam" playsinline autoplay muted style="width:100%;border-radius:12px;background:#000"></video>
        </div>
        <div class="actions" style="margin-top:10px;gap:8px;flex-wrap:wrap">
          <button class="btn" id="toggleFacing">â†”ï¸ Cambiar cÃ¡mara</button>
          <button class="btn" id="capture">ğŸ“¸ Capturar foto</button>
        </div>
        <p class="hint">En mÃ³vil, â€œCambiar cÃ¡maraâ€ alterna frontal (espejo) y trasera (normal).</p>
      </div>
      <div>
        <label>PrevisualizaciÃ³n de la foto</label>
        <div class="preview" id="prev">AÃºn sin captura</div>
      </div>
    </div>

    <div class="actions">
      <a class="btn" href="index.html">â† Volver</a>
      <button class="btn primary" id="next" disabled>Siguiente â†’</button>
    </div>
  </div>
</main>

<script>
let imgData = null;
const video = document.getElementById('cam');
const prev = document.getElementById('prev');
const btnCap = document.getElementById('capture');
const btnNext = document.getElementById('next');
const btnFacing = document.getElementById('toggleFacing');

let currentStream;
let facingMode = 'user';   // 'user' (frontal) | 'environment' (trasera)
let mirrorOn = true;       // espejo si frontal

async function startCamera() {
  try {
    if (currentStream) currentStream.getTracks().forEach(t=>t.stop());

    const constraints = {
      video: { facingMode: { ideal: facingMode }, width:{ideal:1280}, height:{ideal:720} },
      audio: false
    };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    currentStream = stream;
    video.srcObject = stream;

    // aplica espejo solo si estamos en frontal
    mirrorOn = (facingMode === 'user');
    video.classList.toggle('mirror', mirrorOn);
  } catch (e) {
    alert('No se pudo acceder a la cÃ¡mara. Revisa permisos o usa otro navegador.');
    console.error(e);
  }
}
startCamera();

// alternar frontal/trasera
btnFacing.addEventListener('click', async ()=>{
  facingMode = (facingMode === 'user') ? 'environment' : 'user';
  await startCamera();
});

// capturar frame â†’ JPEG (si mirrorOn, capturamos espejado)
btnCap.addEventListener('click', ()=>{
  if (!video.videoWidth) { alert('La cÃ¡mara aÃºn no estÃ¡ lista.'); return; }

  const max = 1400;
  let w = video.videoWidth, h = video.videoHeight;
  const r = Math.min(max/w, max/h, 1);

  const c = document.createElement('canvas');
  c.width = Math.round(w*r); c.height = Math.round(h*r);
  const cx = c.getContext('2d');

  if (mirrorOn) { cx.translate(c.width, 0); cx.scale(-1, 1); }
  cx.drawImage(video, 0, 0, c.width, c.height);

  imgData = c.toDataURL('image/jpeg', 0.9);

  prev.innerHTML = '';
  const img = new Image();
  img.src = imgData; img.style.maxWidth='100%'; img.style.borderRadius='10px';
  prev.appendChild(img);
  btnNext.disabled = false;
});

// guardar y pasar
btnNext.addEventListener('click', ()=>{
  const text = document.getElementById('headText').value.trim();
  if (typeof writeTmp === 'function') {
    writeTmp({ headText: text, headImg: imgData || null });
  } else {
    sessionStorage.setItem('headText', text);
    sessionStorage.setItem('headImg', imgData || '');
  }
  if (currentStream) currentStream.getTracks().forEach(t=>t.stop());
  location.href = 'q2.html';
});

// limpiar stream al salir
window.addEventListener('pagehide', ()=>{
  if (currentStream) currentStream.getTracks().forEach(t=>t.stop());
});
</script>
</body></html>
